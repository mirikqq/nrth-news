# CHRONICLE — Новостной портал с аналитикой посетителей

Django-проект новостного сайта с системой геолокации посетителей через OpenStreetMap.

---

## Структура проекта

```
newssite/
├── manage.py
├── requirements.txt
├── newssite/                   # Настройки проекта
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── news/                       # Приложение новостей
│   ├── models.py               # News, Visitor
│   ├── views.py                # Страницы и API
│   ├── urls.py                 # Маршруты
│   ├── admin.py                # Регистрация в админке
│   ├── middleware.py            # GeoTrackingMiddleware
│   ├── services.py             # Геолокация IP
│   ├── migrations/
│   └── management/commands/
│       └── populate_db.py      # Тестовые данные
└── templates/news/
    ├── base.html               # Базовый шаблон
    ├── news_list.html          # Список новостей
    ├── news_detail.html        # Полная новость
    └── visitors_map.html       # Карта посетителей
```

---

## Быстрый старт

```bash
# 1. Создаём виртуальное окружение
python -m venv venv
source venv/bin/activate        # Windows: venv\Scripts\activate

# 2. Устанавливаем зависимости
pip install -r requirements.txt

# 3. Миграции
python manage.py migrate

# 4. Заполняем тестовыми данными (новости + посетители)
python manage.py populate_db

# 5. Запускаем сервер
python manage.py runserver
```

Сайт будет доступен по адресу: **http://127.0.0.1:8000/**

---

## Страницы

| URL | Описание |
|---|---|
| `/` | Список новостей (сетка карточек) |
| `/news/<id>/` | Полная статья |
| `/visitors/` | Карта посетителей + статистика |
| `/visitors/api/` | JSON API данных посетителей |
| `/admin/` | Django Admin (добавление/удаление новостей) |

---

## Как добавлять новости

1. Перейдём в **http://127.0.0.1:8000/admin/**
2. Логин/пароль суперюзера (создадим при необходимости: `python manage.py createsuperuser`)
3. Раздел **Новости → Добавить новость**
4. Заполняем поля:
   - **Фотография** — загрузка изображения (необязательно)
   - **Название новости**
   - **Краткое описание** — анонс на карточке
   - **Полное описание** — текст статьи
   - **Дата публикации** — по умолчанию текущее время

---

## Система геолокации

### Как работает

Middleware `GeoTrackingMiddleware` перехватывает каждый GET-запрос:

1. Извлекаем IP адрес из заголовков (`X-Forwarded-For` или `REMOTE_ADDR`)
2. Если IP приватный (localhost, 127.0.0.1) — пропускаем
3. Вызываем внешний API для определения геолокации
4. Сохраняем запись в таблицу `Visitor`

### Поддержка провайдеров геолокации

| Провайдер | Бесплатный план | API ключ | Точность |
|---|---|---|---|
| **ip-api.com** ✓ (по умолчанию) | 45 запросов/мин | Не нужен | Город, страна |
| **ipstack.com** | 1000 запросов/мес | Нужен | Город, регион, страна |
| **ipgeolocation.io** | 1000 запросов/мес | Нужен | Город, регион, страна |

**ip-api.com** используется по умолчанию — работает без ключа API.

Для подключения ipstack:
```python
# settings.py
GEO_API_PROVIDER = 'ipstack'
GEOIP_API_KEY = 'ваш_ключ_здесь'  # https://ipstack.com/
```

### Карта посетителей

- Реализована на **Leaflet.js** + **OpenStreetMap**
- Маркеры автоматически загружаются через API `/visitors/api/`
- Поп-ап при кликом на маркер показывает город, страну и IP
- Карта автоматически масштабируется под все точки

---

## Тестовые данные

Команда `populate_db` создаёт:
- **6 новостей** с текстом
- **20 уникальных IP** с геолокацией по всему миру (Москва, Лондон, Токио, Нью-Йорк и т.д.)
- **30–60 записей посетителей** (по 1–3 визита на каждый IP)

---

## Примечания

- На **localhost** геолокация не работает (приватный IP) — для тестирования карты используйте `populate_db`
- Изображения новостей сохраняются в папку `media/news_photos/`
- Язык интерфейса Django Admin: русский (`LANGUAGE_CODE = 'ru'`)
- Для продакшена замените `SECRET_KEY` и отключите `DEBUG = False`
