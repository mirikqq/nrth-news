{% extends "news/base.html" %}

{% block title %}Аналитика посетителей{% endblock %}

{% block extra_styles %}
    /* ─── Stats Row ─── */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 48px;
    }

    .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 28px 24px;
        position: relative;
        overflow: hidden;
        transition: border-color var(--transition);
    }

    .stat-card:hover {
        border-color: var(--border-light);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent);
        opacity: 0;
        transition: opacity var(--transition);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-card__label {
        font-size: 10px;
        font-weight: 500;
        letter-spacing: 2.5px;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 10px;
    }

    .stat-card__value {
        font-family: var(--font-display);
        font-size: 38px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .stat-card__value span {
        color: var(--accent);
    }

    .stat-card__sub {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 8px;
    }

    /* ─── Map Section ─── */
    .map-section {
        margin-bottom: 56px;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .section-title {
        font-family: var(--font-display);
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .section-badge {
        font-size: 10px;
        font-weight: 500;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        color: var(--accent);
        background: var(--accent-dim);
        padding: 4px 10px;
        border-radius: 2px;
    }

    #map-container {
        width: 100%;
        height: 440px;
        border-radius: var(--radius);
        overflow: hidden;
        border: 1px solid var(--border);
        position: relative;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    /* Кастомный стиль для Leaflet на light theme */
    .leaflet-tile-pane { filter: none; }

    .leaflet-control-zoom {
        background: #fff !important;
        border-color: var(--border) !important;
        border-radius: var(--radius) !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }

    .leaflet-control-zoom a {
        color: var(--text-secondary) !important;
        background: transparent !important;
        border-bottom-color: var(--border) !important;
    }

    .leaflet-control-zoom a:hover {
        color: var(--accent) !important;
        background: var(--bg-card-hover) !important;
    }

    .leaflet-control-attribution {
        background: rgba(255,255,255,0.85) !important;
        color: var(--text-muted) !important;
        font-size: 10px !important;
    }

    .leaflet-control-attribution a { color: var(--accent) !important; }

    /* Custom marker */
    .custom-marker {
        width: 12px;
        height: 12px;
        background: var(--accent);
        border: 2px solid #fff;
        border-radius: 50%;
        box-shadow: 0 0 0 2px var(--accent-glow), 0 2px 6px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .custom-marker:hover {
        transform: scale(1.4);
        box-shadow: 0 0 0 3px var(--accent-glow), 0 3px 10px rgba(0,0,0,0.25);
    }

    /* Popup style */
    .leaflet-popup-content-wrapper {
        background: #fff !important;
        border: 1px solid var(--border) !important;
        border-radius: var(--radius) !important;
        color: var(--text-primary) !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
    }

    .leaflet-popup-tip {
        background: #fff !important;
    }

    .leaflet-popup-content {
        font-size: 13px !important;
        line-height: 1.6 !important;
    }

    .popup-city { font-weight: 600; color: var(--accent); }
    .popup-country { color: var(--text-secondary); font-size: 12px; }
    .popup-ip { color: var(--text-muted); font-size: 11px; font-family: monospace; }

    /* ─── Table Section ─── */
    .table-section {
        margin-bottom: 60px;
    }

    .table-wrap {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: var(--bg-secondary);
    }

    thead th {
        font-size: 10px;
        font-weight: 500;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-muted);
        padding: 14px 18px;
        text-align: left;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
    }

    tbody tr {
        border-bottom: 1px solid var(--border);
        transition: background var(--transition);
    }

    tbody tr:last-child { border-bottom: none; }

    tbody tr:hover {
        background: var(--bg-card-hover);
    }

    tbody td {
        padding: 13px 18px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    td.td-ip {
        font-family: 'SF Mono', 'Fira Code', monospace;
        font-size: 12px;
        color: var(--text-primary);
    }

    td.td-city { color: var(--text-primary); font-weight: 500; }
    td.td-time { color: var(--text-muted); font-size: 12px; }

    .flag {
        margin-right: 6px;
    }

    /* ─── Country Stats ─── */
    .country-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
    }

    .country-row:last-child { border-bottom: none; }

    .country-row__name { font-size: 13px; color: var(--text-secondary); }
    .country-row__count {
        font-size: 12px;
        font-weight: 500;
        color: var(--accent);
        background: var(--accent-dim);
        padding: 2px 10px;
        border-radius: 2px;
    }

    /* Loading / Empty */
    .loading-text {
        text-align: center;
        color: var(--text-muted);
        font-size: 13px;
        padding: 40px;
        letter-spacing: 1px;
    }

    @media (max-width: 700px) {
        #map-container { height: 320px; }
        .stats-row { grid-template-columns: 1fr 1fr; }
        thead th, tbody td { padding: 10px 12px; }
    }

    .leaflet-control-attribution.leaflet-control {
        display: none!important;
    }
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="page-header__label">Аналитика</div>
        <h1 class="page-header__title">Посетители<br><em>и геолокация</em></h1>
        <p class="page-header__subtitle">Реальный мониторинг расположения посетителей сайта через определение IP адреса.</p>
    </div>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-card__label">Всего визитов</div>
            <div class="stat-card__value">{{ total_visits|default:"0" }}</div>
            <div class="stat-card__sub">за всё время</div>
        </div>
        <div class="stat-card">
            <div class="stat-card__label">Уникальных IP</div>
            <div class="stat-card__value">{{ unique_visitors|default:"0" }}</div>
            <div class="stat-card__sub">уникальных посетителей</div>
        </div>
        <div class="stat-card">
            <div class="stat-card__label">Странах</div>
            <div class="stat-card__value">{{ country_stats|length }}</div>
            <div class="stat-card__sub">разных стран</div>
        </div>
    </div>

    <!-- Map -->
    <div class="map-section">
        <div class="section-header">
            <h2 class="section-title">Карта посетителей</h2>
            <span class="section-badge" id="map-badge">Загрузка...</span>
        </div>
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Two-column: table + country stats -->
    <div style="display: grid; grid-template-columns: 1.6fr 1fr; gap: 32px;">
        <!-- Visitors Table -->
        <div class="table-section">
            <div class="section-header">
                <h2 class="section-title">Список посетителей</h2>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>IP адрес</th>
                            <th>Город</th>
                            <th>Страна</th>
                            <th>Время</th>
                        </tr>
                    </thead>
                    <tbody id="visitors-table-body">
                        <tr><td colspan="4" class="loading-text">Загрузка данных...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Country Stats -->
        <div class="table-section">
            <div class="section-header">
                <h2 class="section-title">По странам</h2>
            </div>
            <div style="border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px;">
                {% if country_stats %}
                    {% for cs in country_stats %}
                    <div class="country-row">
                        <span class="country-row__name">{{ cs.country }}</span>
                        <span class="country-row__count">{{ cs.count }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="loading-text" style="padding: 20px 0;">Пока нет данных</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Leaflet CSS + JS from cdnjs (no integrity attr — cdnjs/Cloudflare HTTPS is sufficient) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ─── Init Map ───
    const map = L.map('map', {
        center: [55.0, 37.0],
        zoom: 3,
        zoomControl: true,
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(map);

    // ─── Custom Marker Icon ───
    const markerIcon = L.divIcon({
        className: '',
        html: '<div class="custom-marker"></div>',
        iconSize: [12, 12],
        iconAnchor: [6, 6],
        popupAnchor: [0, -10]
    });

    // ─── Fetch visitors and render ───
    fetch('/visitors/api/')
        .then(r => r.json())
        .then(data => {
            const visitors = data.visitors;
            const badge = document.getElementById('map-badge');
            badge.textContent = visitors.length + ' точек на карте';

            // Markers on map
            visitors.forEach(v => {
                const marker = L.marker([v.lat, v.lon], { icon: markerIcon }).addTo(map);
                const popupHtml =
                    '<div>' +
                        '<div class="popup-city">' + (v.city || 'Неизвестный город') + '</div>' +
                        '<div class="popup-country">' + (v.country || 'Неизвестная страна') + ', ' + (v.region || '') + '</div>' +
                        '<div class="popup-ip">' + v.ip + ' · ' + v.visited_at + '</div>' +
                    '</div>';
                marker.bindPopup(popupHtml, { maxWidth: 220 });
            });

            // Fit map to all markers
            if (visitors.length > 0) {
                var bounds = visitors.map(v => [v.lat, v.lon]);
                try {
                    map.fitBounds(bounds, { padding: [40, 40], maxZoom: 6 });
                } catch(e) { /* keep default view */ }
            }

            // ─── Table ───
            const tbody = document.getElementById('visitors-table-body');
            if (visitors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading-text">Посетителей ещё нет</td></tr>';
                return;
            }

            let rows = '';
            visitors.forEach(v => {
                rows +=
                    '<tr>' +
                        '<td class="td-ip">' + v.ip + '</td>' +
                        '<td class="td-city">' + (v.city || '—') + '</td>' +
                        '<td>' + (v.country || '—') + '</td>' +
                        '<td class="td-time">' + v.visited_at + '</td>' +
                    '</tr>';
            });
            tbody.innerHTML = rows;
        })
        .catch(function(err) {
            console.error('Failed to load visitors:', err);
            document.getElementById('map-badge').textContent = 'Ошибка загрузки';
            document.getElementById('visitors-table-body').innerHTML =
                '<tr><td colspan="4" class="loading-text">Не удалось загрузить данные</td></tr>';
        });
});
</script>
{% endblock %}
